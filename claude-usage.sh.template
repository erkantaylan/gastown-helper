#!/bin/bash
# claude-usage.sh - Display Claude usage for tmux status bar
# Combines local stats + web API usage data

CLAUDE_DIR="$HOME/.claude"
CREDENTIALS_FILE="$CLAUDE_DIR/.credentials.json"
STATS_FILE="$CLAUDE_DIR/stats-cache.json"
CACHE_FILE="$CLAUDE_DIR/usage-cache.json"
CACHE_TTL=300  # 5 minutes

export NO_COLOR=1

# Check if we should use cached data
use_cache() {
    if [ -f "$CACHE_FILE" ]; then
        local age=$(( $(date +%s) - $(stat -c %Y "$CACHE_FILE" 2>/dev/null || echo 0) ))
        [ "$age" -lt "$CACHE_TTL" ]
    else
        return 1
    fi
}

# Fetch usage from Claude.ai API
fetch_web_usage() {
    # Extract OAuth token and orgId
    local oauth_data=$(cat "$CREDENTIALS_FILE" 2>/dev/null | python3 -c "
import json, sys
data = json.load(sys.stdin)
oauth = data.get('claudeAiOauth', {})
print(oauth.get('sessionKey', ''))
print(oauth.get('orgId', ''))
" 2>/dev/null)

    local session_key=$(echo "$oauth_data" | head -1)
    local org_id=$(echo "$oauth_data" | tail -1)

    if [ -z "$session_key" ] || [ -z "$org_id" ]; then
        echo "{}" > "$CACHE_FILE"
        return 1
    fi

    # Fetch usage data
    curl -s "https://claude.ai/api/organizations/$org_id/usage" \
        -H "Cookie: sessionKey=$session_key" \
        -H "User-Agent: Mozilla/5.0" \
        2>/dev/null > "$CACHE_FILE"
}

# Get local stats
get_local_stats() {
    if [ ! -f "$STATS_FILE" ]; then
        echo "0|0|0"
        return
    fi

    python3 -c "
import json, sys
try:
    with open('$STATS_FILE') as f:
        data = json.load(f)

    # Get today's activity
    daily = data.get('dailyActivity', [])
    today = daily[0] if daily else {}
    messages = today.get('messageCount', 0)

    # Get model usage
    models = data.get('modelUsage', {})
    total_input = sum(m.get('inputTokens', 0) for m in models.values())
    total_output = sum(m.get('outputTokens', 0) for m in models.values())

    print(f'{messages}|{total_input}|{total_output}')
except:
    print('0|0|0')
" 2>/dev/null
}

# Parse web usage and format output
format_output() {
    local local_stats=$(get_local_stats)
    local messages=$(echo "$local_stats" | cut -d'|' -f1)
    local input_tokens=$(echo "$local_stats" | cut -d'|' -f2)
    local output_tokens=$(echo "$local_stats" | cut -d'|' -f3)

    # Parse web usage if available
    if [ -f "$CACHE_FILE" ]; then
        python3 -c "
import json, sys
from datetime import datetime

try:
    with open('$CACHE_FILE') as f:
        data = json.load(f)

    # Parse 5-hour and 7-day usage
    five_hour = data.get('five_hour', {})
    seven_day = data.get('seven_day', {})

    five_util = five_hour.get('utilization', 0)
    seven_util = seven_day.get('utilization', 0)

    # Format: ðŸ¤– 5h:45% 7d:12% | ðŸ“Š123msg 45kâ†‘ 78kâ†“
    five_pct = int(five_util * 100)
    seven_pct = int(seven_util * 100)

    # Color indicators based on usage
    five_icon = 'ðŸ”´' if five_pct > 80 else 'ðŸŸ¡' if five_pct > 50 else 'ðŸŸ¢'
    seven_icon = 'ðŸ”´' if seven_pct > 80 else 'ðŸŸ¡' if seven_pct > 50 else 'ðŸŸ¢'

    # Format token counts (k = thousands)
    input_k = $input_tokens / 1000
    output_k = $output_tokens / 1000

    # Show ONLY 5h/7d percentages (the important metrics)
    if five_pct > 0 or seven_pct > 0:
        print(f'{five_icon}5h:{five_pct}% {seven_icon}7d:{seven_pct}%')
    else:
        # No API data yet - show simple indicator
        print('ðŸ¤– ...')

except Exception as e:
    # No API data available
    print('ðŸ¤– ...')
" 2>/dev/null || echo "ðŸ¤– ..."
    else
        # No web data yet
        echo "ðŸ¤– ..."
    fi
}

# Main logic
if ! use_cache && [ -f "$CREDENTIALS_FILE" ]; then
    fetch_web_usage &
fi

format_output
