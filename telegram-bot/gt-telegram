#!/bin/bash
# Send a message to the overseer's Telegram from CLI
# Usage: gt-telegram "your message here"
#        echo "message" | gt-telegram

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "$0")")" && pwd)"

# Load .env
if [ -f "$SCRIPT_DIR/.env" ]; then
    export $(grep -v '^#' "$SCRIPT_DIR/.env" | grep -v '^\s*$' | xargs)
fi

if [ -z "${TELEGRAM_BOT_TOKEN:-}" ] || [ -z "${TELEGRAM_CHAT_ID:-}" ]; then
    echo "Error: TELEGRAM_BOT_TOKEN and TELEGRAM_CHAT_ID must be set in $SCRIPT_DIR/.env" >&2
    exit 1
fi

# Get message from args or stdin
if [ $# -gt 0 ]; then
    MESSAGE="$*"
elif [ ! -t 0 ]; then
    MESSAGE="$(cat)"
else
    echo "Usage: gt-telegram <message>" >&2
    echo "       echo 'message' | gt-telegram" >&2
    exit 1
fi

# Send to each chat ID (comma-separated)
IFS=',' read -ra CHAT_IDS <<< "$TELEGRAM_CHAT_ID"
for CHAT_ID in "${CHAT_IDS[@]}"; do
    CHAT_ID="$(echo "$CHAT_ID" | tr -d ' ')"
    RESULT=$(curl -s "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
        -d "chat_id=${CHAT_ID}" \
        -d "text=${MESSAGE}" \
        -d "parse_mode=Markdown")

    OK=$(echo "$RESULT" | python3 -c "import sys,json; print(json.load(sys.stdin).get('ok','false'))" 2>/dev/null || echo "false")
    if [ "$OK" = "True" ]; then
        echo "✓ Sent to ${CHAT_ID}"
    else
        echo "✗ Failed to send to ${CHAT_ID}: $RESULT" >&2
    fi
done
